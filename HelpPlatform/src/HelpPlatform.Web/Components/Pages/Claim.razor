@using HelpPlatform.Web.DonationRequests.Claims
@inject NavigationManager NavigationManager
@inject HttpClient HttpClient

<div class="row">
	<EditForm Model="@claim" OnSubmit="ValidateData" FormName="ClaimRequest">
		<div class="mb-3">
			<label for="description" class="form-label">Description</label>
			<InputText id="description" class="form-control" @bind-Value="claim.Message" />
		</div>

		<div class="mb-3">
			<label for="deadline" class="form-label">Deadline</label>
			<DateInput id="deadline" class="form-control" TValue="DateTime?" @bind-Value="claim.Deadline" EnableMinMax="true" Placeholder="Enter Date" />
		</div>
	</EditForm>
	<button type="submit" class="btn btn-primary">Save</button>
	<div class="mt-3">@Message</div>
</div>

@code {
	[Parameter] public EventCallback OnClaimCreated { get; set; }

	[Parameter] public int RequestId { get; set; }

	private string Message = String.Empty;

	[SupplyParameterFromForm]
	private CreateDonationRequestClaimRequest claim { get; set; } = new();

	protected override void OnInitialized()
	{
		base.OnInitialized();
	}

	private async Task ValidateData(EditContext editContext)
	{
		try
		{
			Message = "Salvando...";
			claim.UserId = 1;
			claim.RequestId = RequestId;

			HttpResponseMessage response = await HttpClient.PostAsJsonAsync(NavigationManager.BaseUri + "DonationRequests/" + RequestId + "/claims", claim);

			if (response.IsSuccessStatusCode)
			{
				Message = "Salvo!";
				if (OnClaimCreated.HasDelegate)
				{
					await OnClaimCreated.InvokeAsync(null);
				}
			}
			else
			{
				Message = $"Erro: {response.Content}";
			}
		}
		catch (Exception ex)
		{
			Message = $"Error: {ex.Message}";
		}
	}
}
