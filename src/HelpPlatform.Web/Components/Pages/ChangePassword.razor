@page "/change-password"
@using System.Net.Http.Json
@using HelpPlatform.Web.Identity

<PageTitle>Alterar Senha</PageTitle>

<h3>Alterar Senha</h3>

@if (responseMessage != null)
{
    <div class="alert @responseClass">@responseMessage</div>
}

<EditForm Model="changePasswordRequest" OnValidSubmit="SubmitChangePassword">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="currentPassword">Senha Atual</label>
        <InputText id="currentPassword" class="form-control" type="password" @bind-Value="changePasswordRequest.CurrentPassword" />
    </div>

    <div class="form-group">
        <label for="newPassword">Nova Senha</label>
        <InputText id="newPassword" class="form-control" type="password" @bind-Value="changePasswordRequest.NewPassword" />
    </div>

    <div class="form-group">
        <label for="confirmNewPassword">Confirmar Nova Senha</label>
        <InputText id="confirmNewPassword" class="form-control" type="password" @bind-Value="changePasswordRequest.ConfirmNewPassword" />
    </div>

    <button type="submit" class="btn btn-primary">Alterar Senha</button>
</EditForm>

@code {
    private ChangePasswordRequest changePasswordRequest = new ChangePasswordRequest();
    private string? responseMessage;
    private string responseClass = "alert-success";

    private async Task SubmitChangePassword()
    {
        try
        {
            var httpResponse = await Http.PostAsJsonAsync("/change-password", changePasswordRequest);

            if (httpResponse.IsSuccessStatusCode)
            {
                var response = await httpResponse.Content.ReadFromJsonAsync<ChangePasswordResponse>();
                responseMessage = response?.Message;
                responseClass = "alert-success";
            }
            else
            {
                var errorResponse = await httpResponse.Content.ReadFromJsonAsync<ChangePasswordResponse>();
                responseMessage = errorResponse?.Message;
                responseClass = "alert-danger";
            }
        }
        catch (Exception ex)
        {
            responseMessage = $"Erro ao alterar a senha: {ex.Message}";
            responseClass = "alert-danger";
        }
    }
}
