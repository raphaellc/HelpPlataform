@page "/myrequests"
@rendermode InteractiveServer
@using HelpPlatform.Web.DonationRequests
@using HelpPlatform.Web.DonationRequests.Claims
@using System.Globalization
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager

<PageTitle>Help Requests</PageTitle>
<div class="page-title">
	<h1>My Requests</h1>
	<Button Color="ButtonColor.Primary" @onclick="() => CreateRequest(0)">Create New Request</Button>
</div>

<Offcanvas @ref="offcanvas" OnRequestCreated="HandleRequestCreated" />

<div class="page-container">

	@if (isLoading)
	{
		<p>Loading...</p>
	}
	else
	{
		<div class="content">
			<Tabs EnableFadeEffect="true">
				@foreach (String status in statusList)
				{
					<Tab Title=@status Disabled=DisabledTab(status)>
						<Content>
							<div class="request-list">
								@foreach (var request in donationRequests)
								{
									@if (request.status == status)
									{
										<div class="mb-4">
											<h3>@CreateTitle(request.resourceTypeId, request.requestedQuantity, request.location, request.deadline)</h3>
											<div class="d-flex flex-wrap">
												@if (claimsDictionary.TryGetValue(request.id, out var claimsResponse) && claimsResponse?.Claims != null && claimsResponse.Claims.Any())
												{
													@foreach (var claim in claimsResponse.Claims)
													{
														<div class="card me-3 mb-3" style="width: 18rem;">
															<div class="card-body">
																<h5 class="card-title">
																	@CreateTitle(claim.Id, claim.Quantity, "", claim.Deadline)
																</h5>
																<p class="card-text">
																	@claim.Message
																</p>
																<div class="d-flex justify-content-between">
																	<a href="#" class="btn btn-primary">Accept</a>
																	<a href="#" class="btn btn-secondary">Reject</a>
																</div>
															</div>
														</div>
													}
												}
												else
												{
													<p>No claims available for this request.</p>
												}
											</div>
										</div>
									}
								}
							</div>
							<div class="pagination">
								<Pagination ActivePageNumber="@currentPageNumber"
												TotalPages="@totalPages"
												PageChanged="OnPageChangedAsync" />
							</div>
						</Content>
					</Tab>
				}
			</Tabs>
		</div>
	}
</div>

@code {
	int currentPageNumber = 1;
	int totalPages = 10;
	private ListDonationRequestResponse response = new ListDonationRequestResponse();
	private List<DonationRequestRecord> donationRequests = [];
	private Dictionary<int, ListDonationRequestClaimsResponse?> claimsDictionary = new();
	private String[] statusList = ["Open", "PartiallyClaimed", "Claimed", "Completed", "Closed"];
	private bool isLoading = true;

	protected override async Task OnInitializedAsync()
	{
		ListDonationRequestResponse? response = await HttpClient.GetFromJsonAsync<ListDonationRequestResponse>(NavigationManager.BaseUri + "DonationRequests");

		donationRequests = response?.DonationRequests ?? [];

		foreach (var request in donationRequests)
		{
			var claimsResponse = await GetListDonationRequestClaimsResponseAsync(request);
			claimsDictionary[request.id] = claimsResponse;
		}

		isLoading = false;
	}

	private Offcanvas offcanvas = default!;

	protected async Task ClaimRequest(int id)
	{
		var parameters = new Dictionary<string, object>();
		parameters.Add("RequestId", id);
		await offcanvas.ShowAsync<Claim>(title: "Donation Request", parameters: parameters);
	}
	protected async Task CreateRequest(int id)
	{
		await offcanvas.ShowAsync<CreateRequest>(title: "Create Request");
	}

	private async Task HandleRequestCreated()
	{
		ListDonationRequestResponse? response = await HttpClient.GetFromJsonAsync<ListDonationRequestResponse>(NavigationManager.BaseUri + "DonationRequests");

		donationRequests = response?.DonationRequests ?? [];
	}

	private int CalculateQuantity(DonationRequestRecord request)
	{
		return request.fulfilledQuantity * 100 / request.requestedQuantity;
	}

	private string CreateTitle(int resource, int quantity, string location, DateTime? deadline)
	{
		return resource + "\t" + quantity + "\t" + location + "\t" + deadline;
	}

	private bool DisabledTab(String status)
	{
		return !donationRequests.Any(request => request.status == status);
	}

	private async Task<ListDonationRequestClaimsResponse?> GetListDonationRequestClaimsResponseAsync(DonationRequestRecord request)
	{
		return await HttpClient.GetFromJsonAsync<ListDonationRequestClaimsResponse>(NavigationManager.BaseUri + "DonationRequests/" + request.id + "/Claims");
	}

	private async Task OnPageChangedAsync(int newPageNumber)
	{
		await Task.Run(() => { currentPageNumber = newPageNumber; });
	}
}

<style>
	.page-title {
		display: flex; /* Enable flexbox for layout */
		justify-content: space-between; /* Space between items */
		align-items: center; /* Center items vertically */
		padding: 20px; /* Add padding for the container */
		border-bottom: 1px solid #ddd; /* Optional border for visual separation */
	}

	.page-title h1 {
		margin: 0; /* Remove default margin from h1 */
	}

	.page-container {
		display: flex;
		flex-direction: column;
	}

	.content {
		flex: 1; /* This allows content to grow and take available space */
		padding: 20px; /* Add padding for the content */
	}

	.pagination {
		padding-left: 10px; /* Add padding for the pagination */
		padding-top: 5px;
	}

	.action-button {
		margin-top: 5px;
		display: flex; /* Enable flexbox for alignment */
	}

	.request-details {
		display: flex;
		flex-wrap: wrap; /* Allow items to wrap */
	}

	.detail {
		flex: 1 1 50%; /* Two-column layout */
		padding: 5px;
	}

	.page-title {
		display: flex;
		flex: 1; /* This allows content to grow and take available space */
		flex-wrap: wrap; /* Allow items to wrap */
	}
</style>